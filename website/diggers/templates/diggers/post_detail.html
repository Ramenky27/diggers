{% extends 'diggers/layouts/blog.html' %}
{% load mptt_tags %}
{% load static %}
{% load plural %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
    <article class="entry">

        <header class="entry__header">

            <h2 class="entry__title h1">
                <a href="{% url 'diggers:post_detail' post.pk %}" title="">{{ post.title }}</a>
            </h2>

            <div class="entry__meta">
                <ul>
                    <li>{{ post.created_date }}</li>
                    <li>
                        <a href="{% url 'diggers:list_by_category' category=post.category.route %}" title=""
                           rel="category tag">{{ post.category.name }}</a>
                    </li>
                    <li><a href="{% url 'diggers:list_by_author' post.author %}">{{ post.author }}</a></li>
                    {% if request.user.is_authenticated and post.author == request.user or perms.diggers.moderate_post %}
                        {% if perms.diggers.change_post %}
                            <li><a href="{% url "diggers:post_update" post.pk %}" title="">Редагувати</a></li>
                        {% endif %}

                        {% if perms.diggers.delete_cmspost %}
                            <li><a href="{% url "diggers:post_delete" post.pk %}" title="">Видалити</a></li>
                        {% endif %}
                    {% endif %}
                </ul>

            </div>

        </header> <!-- entry__header -->

        <div class="entry__content">
            {{ post.text|linebreaks }}
        </div> <!-- entry__content -->

        {% if post.tags.all %}
            <p class="entry__tags">
                <span>Tagged in </span>:
                {% for tag in post.tags.all %}
                    {% if not forloop.first %}&nbsp;{% endif %}
                    <a href="{% url 'diggers:list_by_tags' tags=tag.name %}">#{{ tag.name }}</a>
                    {% if not forloop.last %}, {% endif %}
                {% endfor %}
            </p>
        {% endif %}

        {% if next_post or prev_post %}
            <ul class="entry__post-nav h-group">
                {% if prev_post %}
                    <li class="prev"><a rel="prev" href="{% url "diggers:post_detail" prev_post.pk %}"><strong
                            class="h6">Попередній пост</strong>
                        {{ prev_post.title }}</a></li>
                {% endif %}
                {% if next_post %}
                    <li class="next"><a rel="next" href="{% url "diggers:post_detail" next_post.pk %}"><strong
                            class="h6">Наступний пост</strong>
                        {{ next_post.title }}</a></li>
                {% endif %}
            </ul>
        {% endif %}

    </article> <!-- end entry -->

    <div class="comments-wrap">

        {% with post.comment_set.all as comments %}
            <div id="comments">
                <h3>{{ comments.count }} коментар{{ comments.count | plural:',я,ів' }}</h3>

                {% if comments %}
                    <!-- START commentlist -->
                    <ol class="commentlist">
                        {% recursetree comments %}
                            <li class="{% if not node.is_leaf_node and node.level == 0 %}thread-alt{% endif %}
                        depth-{{ node.level }} comment {% if node.is_deleted %}deleted{% endif %}"
                                id="comment{{ node.pk }}">

                                <div class="comment__avatar">
                                    {% if node.author.avatar and not node.is_deleted %}
                                        <img src="{{ MEDIA_URL }}{{ node.author.avatar }}" alt="avatar"/>
                                    {% else %}
                                        <img src="{% static "images/thumb.jpg" %}" alt="avatar"/>
                                    {% endif %}
                                </div>

                                <div class="comment__content">

                                    {% if not node.is_deled %}
                                        <div class="comment__info">
                                            <div class="comment__author">{{ node.author.username }}</div>

                                            <div class="comment__meta">
                                                <div class="comment__time">{{ node.created_date }}</div>
                                                {% if request.user.is_authenticated %}
                                                    <div class="comment__reply">
                                                        <a class="comment-reply-link"
                                                           href="{% url 'diggers:comment_answer' node.pk %}">Відповідь</a>
                                                    </div>

                                                    {% if node.author == request.user %}
                                                        <div>
                                                            <a class="comment-reply-link"
                                                               href="{% url 'diggers:comment_update' node.pk %}">Редагувати</a>
                                                            <a class="comment-reply-link"
                                                               href="{% url 'diggers:comment_delete' node.pk %}">Видалити</a>
                                                        </div>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endif %}

                                    <div class="comment__text">
                                        <p>
                                            {% if not node.is_deleted %}
                                                {{ node.text }}
                                            {% else %}
                                                Коментар видалено
                                            {% endif %}
                                        </p>
                                    </div>

                                </div>


                                {% if not node.is_leaf_node %}
                                    <ul class="children">
                                        {{ children }}
                                    </ul>
                                {% endif %}
                            </li> <!-- end comment level {{ node.level }} -->

                        {% endrecursetree %}

                    </ol>
                    <!-- END commentlist -->
                {% endif %}

            </div> <!-- end comments -->
        {% endwith %}

        <div class="comment-respond">
            {% if form %}
                <!-- START respond -->
                <div id="respond">

                    <h3>Додати коментар</h3>

                    <form method="POST" enctype="multipart/form-data"
                          action="{% url 'diggers:comment_create' post.pk %}">
                        {% include "diggers/blocks/form.html" %}
                        <button type="submit" class="btn--primary h-full-width">Відправити</button>
                    </form>
                </div>
                <!-- END respond-->
            {% else %}
                Увійдіть або зареєструйтеся щоб залишати коментарі.
            {% endif %}
        </div> <!-- end comment-respond -->


    </div> <!-- end comments-wrap -->
{% endblock %}